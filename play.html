<!DOCTYPE html>
<html>
  <head>
    <title>Chess</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    
    <!-- Chessboard CSS -->
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">

    <link rel="stylesheet" href="css/styles.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
      crossorigin="anonymous">
    </script>

    <!-- Chessboard JS -->
    <script src="js/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
      body {
        padding: 0 5% 0 5%;
      }

      #board1 {
        width: 100%;
        max-width: 65vh;
        margin: auto;
      }

      @media (max-width: 768px) {
        #board1 {
          width: 100%;
          max-width: 100vh;
        }
        
      }
    </style>
  </head>
  <body>
    <div class="column justify-content-center" style="height: 50px; margin-top: 5vh;">
      <button id="playWhite" class="btn btn-primary">Play as White</button>
      <button id="playBlack" class="btn btn-dark m-2">Play as Black</button>
      <button id="reset" class="btn btn-danger">Reset</button>
    </div>

    <br>


    <div id="board1"></div>

    <br>

    <div class="container text-center">
      <button id="playGame" class="btn btn-success btn-lg fs-3">Play Game</button>
    </div>

    <script>
      let board1;
      let game = new Chess(); // Use chess.js to manage game state
      let selectedSquare = null;
      let boardOrientation = 'white'; // Default
    
      // Initialize board with custom click-to-move interaction
      function initializeBoard(orientation) {
        boardOrientation = orientation;
        game.reset(); // Reset game state
        selectedSquare = null;

        board1 = ChessBoard('board1', {
          position: 'start',
          draggable: false, // Disable dragging
          orientation: orientation,
          pieceTheme: 'img/chesspieces/wikipedia/{piece}.png', // Optional: your theme path
        });

        // Bind click events to squares
        $('#board1 .square-55d63').off('click').on('click', function () {
          const square = $(this).data('square'); // Get the square from the clicked element
          onSquareClick(square);
        });

        $(window).resize(() => board1.resize());
      }
    
      function onSquareClick(square) {
        const moves = game.moves({ square, verbose: true });
    
        // If no piece selected yet or clicked own piece
        if (!selectedSquare) {
          if (moves.length === 0) return; // No moves = not a valid piece
          selectedSquare = square;
          highlightSquares(square, moves.map(m => m.to));
        } else {
          // Try move
          const move = game.move({ from: selectedSquare, to: square });
          if (move === null) {
            // Invalid move, reset selection
            selectedSquare = null;
            removeHighlights();
            return;
          }
    
          board1.position(game.fen());
          selectedSquare = null;
          removeHighlights();
        }
      }
    
      // Highlight helper
      function highlightSquares(from, toSquares) {
        removeHighlights();

        // Highlight the selected square with the yellowish outline
        $(`#board1 .square-${from}`).addClass('highlight1-32417');

        // Add a circle to valid move squares
        toSquares.forEach(square => {
          const targetSquare = $(`#board1 .square-${square}`);
          const piece = game.get(square); // Check if there's a piece on the target square

          if (piece) {
            // If a piece can be captured, use the capture circle style
            targetSquare.append('<div class="valid-move-circle valid-move-circle-capture"></div>');
          } else {
            // Otherwise, use the normal circle style
            targetSquare.append('<div class="valid-move-circle"></div>');
          }
        });
      }
    
      function removeHighlights() {
        // Remove the yellowish outline
        $('#board1 .square-55d63').removeClass('highlight1-32417');

        // Remove all valid move circles
        $('#board1 .valid-move-circle').remove();
      }
    
      // Styling for highlights
      const highlightStyle = `
        <style>
          .highlight-from {
            background-color: rgba(255, 255, 0, 0.6) !important;
          }
    
          .highlight-to {
            background-color: rgba(0, 255, 0, 0.4) !important;
          }
        </style>
      `;
      $('head').append(highlightStyle);
    
      // Buttons
      $('#playWhite').click(() => initializeBoard('white'));
      $('#playBlack').click(() => initializeBoard('black'));
    
      $('#reset').click(() => {
        game.reset();
        board1.start();
        selectedSquare = null;
        removeHighlights();
      });
    
      $('#playGame').click(() => {
        $('.column button').fadeOut();
        $('#board1').parent().animate({ marginTop: '-10vh' }, 500);
        $('#playGame').fadeOut(() => {
          $('#playGame').replaceWith(`
            <div id="difficultyButtons">
              <button class="btn btn-success fs-5 m-1">Easy</button>
              <button class="btn btn-warning fs-5 m-1">Medium</button>
              <button class="btn btn-danger fs-5 m-1">Hard</button>
            </div>
          `);
        });
      });
    
      // Initialize on page load
      initializeBoard('white');
    </script>
  </body>
</html>